---
date: 2014-08-23 12:00:31+00:00
layout: post
title: NGINX之HTTP模块学习
categories: 文档
tags: NGINX学习
---

####http框架配置


----------

#####1. 配置项简介
http框架定义了3个级别的配置main,srv,loc.分别表示直接出现在http{},server{},location{}块内的配置项.

> http模块提供三个回调方法create_main_conf、create_srv_conf、create_loc_conf负责把配置项的结构体传递给http框架。由于上述不用配置项的存在，实现这3个回调方法的意义是不同的。

这种设计更能增强http配置的灵活性而不用担心函数调用的耦合性。


#####2. http配置项的解析方式

 ```c
	struct ngx_command_s {
	    ngx_str_t name;
	    ngx_uint_t type;
	    char *(* set)(ngx_conf_t *cf,ngx_command_t *cmd,void *conf);
	    ngx_uint_t conf;
	    ngx_uint_t offset;
	    void *post;
	 };
```
上述结构体ngx_command_s是nginx的一个基本结构体。其中：

 - `name`是配置项名称，别如扩展中涉及到的的"doumao_print"字符串.
 - `type`决定该配置项可以在哪些块中出现，确切的说是指令的属性，在什么位置出现，带几个参数.
 - `char *(* set)(ngx_conf_t *cf,ngx_command_t *cmd,void *conf)`; 返回值为`char *`的函数指针。这里是指解析指令的回调函数.nginx中提供了14种解析配置项的方法，在自己写扩展的时候可以参考借鉴.
 - conf，用于指示配置项所处内存的相对偏移位置。对于http模块，conf的设置是必要的。如上所说，http会调用指令解析函数，自动将解析出的配置项写入http模块代码定义的结构体中，在配置项简介中了解到，http模块可能定义3个结构体，分别存储于main，srv，loc级别的配置项中。（对应于`create_main_conf,create_srv_conf,create_loc_conf`方法创建的结构体），而http框架在自动解析时需要知道应把解析出的配置项值写入哪个结构体中。这点需要依赖conf配置的值.
 - offset，表示当前配置项在整个存储配置项的结构体中的偏移位置，以字节为单位。举个例子：我们通过指令解析函数回调时，需要通过conf成员找到应该用哪个结构体存放，然后通过offset成员找到这个结构体中的相应成员，以便存放该配置.
 - post，用来辅助指令回调函数，可以使其更加灵活。

举个例子来加深理解，更多可以参见nginx中14种方法的预设解析赋值

```c 
    static ngx_command_t  ngx_doumao_print_commands[] = {
	    { 
			  ngx_string("doumao_print"), 
		      NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
		      //其中NGX_HTTP_LOC_CONF: 是指指令在location配置部分出现是合法的。
	          //NGX_CONF_TAKE1: 指令读入1个参数 这些参数都定义在nginx的模块指令中，模块的指令是定义在一个叫做ngx_command_t的静态数组中。  
		      ngx_doumao_print_readconf,
		      NGX_HTTP_LOC_CONF_OFFSET, 
		      offsetof(ngx_doumao_print_loc_conf_t, ecdata),
			  NULL 
	    },ngx_null_command
    };
```
 

#####3. http配置模型

      
#####4. http扩展项
  


