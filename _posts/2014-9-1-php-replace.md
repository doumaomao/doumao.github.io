---
date: 2014-09-01 15:08:31+00:00
layout: post
title: 记遇到的一匹配问题及php匹配替换函数的学习
categories: 文档
tags: php
---

####记遇到的一个php匹配问题


----------

#####1.神奇的问题

最近有用户说，发帖内容含有“醉風淸”这个词时就悲剧，表现为：发不出去或者发出去变成空白。然后我就试了试 ，输入含有这三个字的内容，结果发现我真的发不出去！！前提是别的字都行。。。然后开始拆分，发“醉”可以发出去，发“風”可以发出去，发“淸”就傻眼了。。。


#####2.追查过程

 - 先看对应的日志，发现在发“淸”这个字时，默认为长度为0。为什么会是0，不管是用gbk后者utf-8都不应该为0啊！！
 - 继续看长度“0”这个结果出自哪里，找了半天，发现了这个入参只是在经过preg_replace后就悲剧了
 - 查看这一行，preg_replace也是使用的其常规用法，主要是将“淸”这次加点html渲染，做成有链接的。想想这也没问题啊
 - 打印入参也没问题。实在不行了，单挑出来preg系列的preg_match来看是不是match上了，要是都match不上，那还替换啥！
 - 最后写了如下代码执行后，返回的false,并且报错说我缺了个']'与其匹配。
```
<?php 
$pattern='/淸/';
$txt='淸_哈哈_我来试试';
$match = preg_match($pattern, $txt);
if ($match===false) {
    echo 'fail';
}
?> 
```
#####3.真相浮出,UTF-8才是王道
 - 在执行该段代码后，我先确认了下我的编码格式是**GBK**，接着我又试了下将文件编码整体改为**UTF-8**，执行后就通过了。这么看是编码问题了啊。
忍不住想，php_match、preg_replace这样的原生函数啊，为啥会有这种问题呢？
 - 突然想到php提示我error，说是缺了**']'**，看了这短短6行代码，哪里来的**'['**呢，将**‘淸’**字的gbk码转换出来为**'%9c%5b'**，再将**'['**的ascii码解析出来，有点懂了，原来**'['**的ascii码值为：**'%5b'**。
 - 此时已经基本明朗了，preg_match、preg_replace函数在匹配GBK编码时为单字节匹配，因为**GBK**编码不像**UTF-8**编码，在读取第一个字节时便已经给出标识并已知具体一个字符占用的字节长度。
 - **GBK**不会给出特殊编码标示，当部分汉字解码的两个字节中有和ascii码本身的一些特殊字符有冲突时，preg_match做出的单个解析会导致上述出现提示缺了**']'**的error，从而导致整个功能匹配替换功能的不可用。
 - 后来我陆陆续续在**GBK**编码下试了下，淺、歔、沎这几个字，果真都是false，也报error。

#####4.小结
上述排查让我很有兴趣去查看下，php的preg系列的函数源码以及mb_ereg系列的学习。并且再一次深深体会，还是utf-8设计贴心！！

####php替换函数的学习


----------

#####1.php替换函数有哪些




